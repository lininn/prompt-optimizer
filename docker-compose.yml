services:
  mysql:
    image: mysql:8.0
    container_name: prompt-optimizer-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${DB_NAME:-prompt}
      - MYSQL_USER=${DB_USER:-promptuser}
      - MYSQL_PASSWORD=${DB_PASS:-promptpass}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootpassword}"]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 60s

  prompt-optimizer:
    image: linshen/prompt-optimizer:latest
#     Alternatively, you can build from source:
    build:
       context: .
       dockerfile: Dockerfile
    container_name: prompt-optimizer
    restart: unless-stopped
    ports:
      - "6020:${NGINX_PORT:-80}"      # Web应用端口（包含MCP服务器，通过/mcp路径访问）
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:${NGINX_PORT:-80}/ && curl -f http://localhost:${NGINX_PORT:-80}/mcp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      mysql:
        condition: service_healthy
    # 增加 MySQL 健康检查的重试次数和超时时间
    command: >
      sh -c "sleep 10 && /start-services.sh"
    environment:
      # nginx内部端口配置
      - NGINX_PORT=${NGINX_PORT:-80}

      # Web应用API配置
      - VITE_OPENAI_API_KEY=${VITE_OPENAI_API_KEY:-}
      - VITE_GEMINI_API_KEY=${VITE_GEMINI_API_KEY:-}
      - VITE_DEEPSEEK_API_KEY=${VITE_DEEPSEEK_API_KEY:-}
      - VITE_SILICONFLOW_API_KEY=${VITE_SILICONFLOW_API_KEY:-}
      - VITE_CUSTOM_API_KEY=${VITE_CUSTOM_API_KEY:-}
      - VITE_CUSTOM_API_BASE_URL=${VITE_CUSTOM_API_BASE_URL:-}
      - VITE_CUSTOM_API_MODEL=${VITE_CUSTOM_API_MODEL:-}

      # MCP服务器配置（Docker内部固定端口3000，不使用MCP_HTTP_PORT）
      # - MCP_HTTP_PORT=${MCP_HTTP_PORT:-3000}  # Docker中固定使用3000端口
      - MCP_LOG_LEVEL=${MCP_LOG_LEVEL:-debug}
      - MCP_DEFAULT_LANGUAGE=${MCP_DEFAULT_LANGUAGE:-zh}
      - MCP_DEFAULT_MODEL_PROVIDER=${MCP_DEFAULT_MODEL_PROVIDER:-openai}

      # 数据库配置
      - DB_TYPE=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=${DB_USER:-promptuser}
      - DB_PASS=${DB_PASS:-promptpass}
      - DB_NAME=${DB_NAME:-prompt}

      # 认证与验证码配置（启用应用内置认证）
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      - AUTH_ALLOW_REGISTRATION=${AUTH_ALLOW_REGISTRATION:-true}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET:-please-change-me-to-a-random-secret}
      - AUTH_JWT_EXPIRES_IN=${AUTH_JWT_EXPIRES_IN:-7d}
      - AUTH_CAPTCHA_TTL_SECONDS=${AUTH_CAPTCHA_TTL_SECONDS:-300}
      - AUTH_CAPTCHA_COOLDOWN_SECONDS=${AUTH_CAPTCHA_COOLDOWN_SECONDS:-5}
      - AUTH_CAPTCHA_COOLDOWN_MAX_REQUESTS=${AUTH_CAPTCHA_COOLDOWN_MAX_REQUESTS:-3}
      - AUTH_PASSWORD_MIN_LENGTH=${AUTH_PASSWORD_MIN_LENGTH:-8}
      - AUTH_PASSWORD_REQUIRE_ALNUM=${AUTH_PASSWORD_REQUIRE_ALNUM:-true}
      - AUTH_RATE_LIMIT_MAX_FAILURES=${AUTH_RATE_LIMIT_MAX_FAILURES:-5}
      - AUTH_RATE_LIMIT_LOCK_MINUTES=${AUTH_RATE_LIMIT_LOCK_MINUTES:-10}

      # Basic认证配置（可选，已禁用）
      # - ACCESS_USERNAME=${ACCESS_USERNAME:-admin}
      # - ACCESS_PASSWORD=${ACCESS_PASSWORD:-123456}
    security_opt:
      - no-new-privileges:true

volumes:
  mysql_data:
